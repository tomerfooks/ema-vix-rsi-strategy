//@version=6
strategy("1h Adaptive Volatility EMA Crossover Strategy", 
         overlay=true, 
         initial_capital=10000,
         default_qty_type=strategy.percent_of_equity,
         default_qty_value=100,
         commission_type=strategy.commission.percent,
         commission_value=0)


// Input parameters - Low Volatility
fastLengthLow = input.int(14, "Fast EMA (Low Vol)", minval=1, group="Low Volatility")
slowLengthLow = input.int(80, "Slow EMA (Low Vol)", minval=1, group="Low Volatility")

// Input parameters - Medium Volatility
fastLengthMed = input.int(25, "Fast EMA (Medium Vol)", minval=1, group="Medium Volatility")
slowLengthMed = input.int(98, "Slow EMA (Medium Vol)", minval=1, group="Medium Volatility")

// Input parameters - High Volatility
fastLengthHigh = input.int(43, "Fast EMA (High Vol)", minval=1, group="High Volatility")
slowLengthHigh = input.int(120, "Slow EMA (High Vol)", minval=1, group="High Volatility")

// Volatility Settings
volatilityLength = input.int(71, "Volatility Lookback Period", minval=10, group="Volatility Settings")
atrLength = input.int(16, "ATR Length", minval=1, group="Volatility Settings")
lowVolPercentile = input.float(28, "Low Volatility Percentile", minval=0, maxval=100, step=1, group="Volatility Settings")
highVolPercentile = input.float(66, "High Volatility Percentile", minval=0, maxval=100, step=1, group="Volatility Settings")

// Calculate volatility metrics
// 1. ATR-based volatility (normalized by price)
atrValue = ta.atr(atrLength)
normalizedATR = (atrValue / close) * 100

// 2. Historical volatility (standard deviation of returns)
returns = math.log(close / close[1])
historicalVol = ta.stdev(returns, volatilityLength) * math.sqrt(252) * 100 // Annualized

// 3. Calculate percentile ranks for current volatility
var array<float> volHistory = array.new_float(volatilityLength, 0)
array.push(volHistory, normalizedATR)
if array.size(volHistory) > volatilityLength
    array.shift(volHistory)

currentVolRank = 0.0
if array.size(volHistory) >= 20 // Need minimum data
    sortedVols = array.copy(volHistory)
    array.sort(sortedVols)
    arraySize = array.size(sortedVols)
    for i = 0 to arraySize - 1
        if array.get(sortedVols, i) <= normalizedATR
            currentVolRank := (i / arraySize) * 100

// Determine volatility regime based on percentile rank
lowVol = currentVolRank < lowVolPercentile
medVol = currentVolRank >= lowVolPercentile and currentVolRank < highVolPercentile
highVol = currentVolRank >= highVolPercentile

// Calculate all EMAs (Pine Script requires fixed lengths)
fastEMA_low = ta.ema(close, fastLengthLow)
slowEMA_low = ta.ema(close, slowLengthLow)
fastEMA_med = ta.ema(close, fastLengthMed)
slowEMA_med = ta.ema(close, slowLengthMed)
fastEMA_high = ta.ema(close, fastLengthHigh)
slowEMA_high = ta.ema(close, slowLengthHigh)

// Select which EMAs to use based on volatility regime
fastEMA = lowVol ? fastEMA_low : medVol ? fastEMA_med : fastEMA_high
slowEMA = lowVol ? slowEMA_low : medVol ? slowEMA_med : slowEMA_high


// Plot EMAs
plot(fastEMA, "Fast EMA (6)", color=color.new(color.green, 0), linewidth=2)
plot(slowEMA, "Slow EMA (20)", color=color.new(color.red, 0), linewidth=2)

// Detect crossovers
bullishCross = ta.crossover(fastEMA, slowEMA)
bearishCross = ta.crossunder(fastEMA, slowEMA)

// Strategy logic
if bullishCross
    strategy.entry("Long", strategy.long)
    
if bearishCross
    strategy.close("Long")

// Visual signals
plotshape(bullishCross, "Buy Signal", shape.triangleup, location.belowbar, 
          color.new(color.green, 0), size=size.small)
plotshape(bearishCross, "Sell Signal", shape.triangledown, location.abovebar, 
          color.new(color.red, 0), size=size.small)

// Background color for position and volatility regime
positionBg = strategy.position_size > 0 ? color.new(color.green, 90) : na 
volBg = lowVol ? color.new(color.blue, 95) : medVol ? color.new(color.yellow, 95) : color.new(color.orange, 95)
bgcolor(positionBg)
bgcolor(volBg, title="Volatility Regime Background")

// Info label
var label infoLabel = na
if bar_index == last_bar_index - 1
    label.delete(infoLabel)
    volText = "Vol: " + str.tostring(normalizedATR, "#.##") + "% | Rank: " + str.tostring(currentVolRank, "#.#") + "%"
    currentFast = lowVol ? fastLengthLow : medVol ? fastLengthMed : fastLengthHigh
    currentSlow = lowVol ? slowLengthLow : medVol ? slowLengthMed : slowLengthHigh
    regimeText = lowVol ? " (LOW - Using " + str.tostring(currentFast) + "/" + str.tostring(currentSlow) + ")" : medVol ? " (MEDIUM - Using " + str.tostring(currentFast) + "/" + str.tostring(currentSlow) + ")" : " (HIGH - Using " + str.tostring(currentFast) + "/" + str.tostring(currentSlow) + ")"
    labelColor = lowVol ? color.new(color.blue, 20) : medVol ? color.new(color.yellow, 20) : color.new(color.orange, 20)
    infoLabel := label.new(bar_index, high, volText + regimeText, 
                           style=label.style_label_down, 
                           color=labelColor,
                           textcolor=medVol ? color.black : color.white)