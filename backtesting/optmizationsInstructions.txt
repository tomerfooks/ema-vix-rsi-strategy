# Strategy Parameter Optimization Instructions

## Data Source

**Alpaca Markets API** is the primary data source:
- Historical data since 2016
- Up to 10,000 bars per request
- Free tier: 200 requests/min
- No 15-minute delay on historical data
- Better data quality and range than yfinance

API credentials are stored in `.env` file (already configured).

## Goal
Find optimal parameters for each symbol-interval-strategy combination through iterative testing and refinement.

## Optimization Targets

### Timeframe Standards
- **1h interval**: 500-10000 candles (Alpaca can provide up to 10,000 bars per request)
- **1d interval**: 1200-3260 candles (8+ years of data available) 

### Date Calculation
- For 1h: Calculate backwards from today to get approximately 4000 candles (~570 days)
- For 1d: Calculate backwards ~5-8 years from today (1200-2000 candles)

## Optimization Process

### 1. When User Requests Optimization

Example: "optimize QQQ 1h adaptive_ema_v2_1"

**Steps:**

a) **Load Existing Parameters (if available)**
   - Check: `strategies/{strategy}/{interval}/params_{SYMBOL}.json`
   - If exists: Use as baseline, try to improve upon it
   - If not exists: Start with strategy defaults

b) **Calculate Date Range**
   - 1h: ~4000 candles backwards from today (about 570 days)
   - 1d: 5-8 years backwards from today (1200-2000 candles)
   
c) **Run Initial Baseline Test**
   ```bash
   python3 main.py --strategy {strategy} --symbol {SYMBOL} \
       --start {start_date} --end {end_date} --interval {interval} \
       --source alpaca \
       --use-saved-params  # if params exist
   ```
   - Record: alpha, total_return, sharpe_ratio, calmar_ratio, max_drawdown, win_rate, num_trades

### 2. Iterative Optimization (5-10 iterations)

**Optimization Strategy:**

- **Primary Metric**: Alpha (vs buy-and-hold)
- **Secondary Metrics**: Sharpe ratio, Calmar ratio, win rate
- **Risk Control**: Max drawdown should be reasonable (<25% for 1h, <30% for 1d)

**Parameter Adjustment Strategy:**

For adaptive_ema_v2_1, iterate through these adjustments:
- `fast_base`: Try [9, 12, 15, 18, 21]
- `slow_base`: Try [18, 21, 26, 30] (must be > fast_base)
- `fast_mult`: Try [1.5, 1.8, 2.0, 2.2, 2.5]
- `slow_mult`: Try [1.2, 1.4, 1.6, 1.8, 2.0]
- `atr_length`: Try [10, 12, 14, 16]
- `vol_threshold`: Try [60, 65, 70, 75, 80]
- `adx_length`: Try [10, 12, 14, 16]
- `adx_threshold`: Try [10.0, 12.0, 15.0, 18.0, 20.0]

**Smart Iteration:**
1. Start with EMA periods (fast_base, slow_base) - biggest impact
2. Then adjust multipliers (fast_mult, slow_mult)
3. Fine-tune volatility parameters (vol_threshold, atr_length)
4. Finally adjust ADX filters (adx_threshold, adx_length)

**Run Command:**
```bash
python3 main.py --strategy {strategy} --symbol {SYMBOL} \
    --start {start_date} --end {end_date} --interval {interval} \
    --source alpaca \
    --fast-base {value} --slow-base {value} --fast-mult {value} \
    --slow-mult {value} --atr-length {value} --vol-threshold {value} \
    --adx-length {value} --adx-threshold {value}
```

**Between Iterations:**
- Track which parameters improve alpha
- Adjust based on results (if longer EMAs help, try even longer)
- Stop if no improvement after 3 consecutive iterations
- Aim for positive alpha

### 3. Save Results (Only if Successful)

**Criteria for Saving:**
- Alpha > 0 (beats buy-and-hold)
- Sharpe ratio > 0.5
- Reasonable max drawdown
- At least 10 trades (not over-fitting)

**Manual Save:**
Create/update the JSON file at: `strategies/{strategy}/{interval}/params_{SYMBOL}.json`

Format:
```json
{
  "symbol": "SYMBOL",
  "interval": "1h",
  "strategy": "adaptive_ema_v2_1",
  "parameters": {
    "fast_base": value,
    "slow_base": value,
    "fast_mult": value,
    "slow_mult": value,
    "atr_length": value,
    "vol_threshold": value,
    "vol_length": 50,
    "adx_length": value,
    "adx_threshold": value
  },
  "performance": {
    "total_return": value,
    "max_drawdown": value,
    "calmar_ratio": value,
    "sharpe_ratio": value,
    "win_rate": value,
    "num_trades": value,
    "alpha": value
  },
  "backtest_period": {
    "start": "YYYY-MM-DD",
    "end": "YYYY-MM-DD",
    "candles": value
  },
  "updated": "2025-11-21",
  "notes": "Optimized - Alpha: X.XX%, N iterations"
}
```

### 4. Report Results

After optimization, provide summary:
```
Optimization Complete: {SYMBOL} {interval} {strategy}
================================================================
Baseline:
  Alpha: {baseline_alpha}%
  Sharpe: {baseline_sharpe}
  Return: {baseline_return}%

Best Result (Iteration {n}):
  Alpha: {best_alpha}% (+{improvement}%)
  Sharpe: {best_sharpe}
  Calmar: {best_calmar}
  Return: {best_return}%
  Max DD: {best_drawdown}%
  Win Rate: {best_winrate}%
  Trades: {num_trades}

Parameters:
  fast_base: {value}
  slow_base: {value}
  fast_mult: {value}
  slow_mult: {value}
  atr_length: {value}
  vol_threshold: {value}
  adx_length: {value}
  adx_threshold: {value}

Status: {SAVED / NOT_SAVED - reason}
```

## Special Cases

### If Parameters Already Exist
- Start with existing params as baseline
- Only save new params if they improve alpha by at least 0.5%
- Document improvement in notes

### If Strategy Performs Worse Than Buy-and-Hold
- Report results but DO NOT save
- Suggest: "Strategy underperforms buy-and-hold. Consider different strategy or timeframe."

### Multiple Symbol Optimization
If user requests "optimize QQQ SPY NVDA 1h", run each symbol sequentially:
1. Optimize QQQ
2. Optimize SPY  
3. Optimize NVDA
4. Provide comparison table at the end

## Example Workflow

User: "optimize QQQ 1h adaptive_ema_v2_1"

1. Load existing params from `strategies/adaptive_ema_v2_1/1h/params_QQQ.json`
2. Run baseline test with existing params
3. Iterate 5-10 times, adjusting parameters intelligently
4. Track best result
5. If best alpha > existing alpha, save new parameters
6. Report comprehensive results with before/after comparison

## Tools Available

- `python3 main.py` - Run backtests with specific parameters
  - Add `--source alpaca` to use Alpaca data (recommended)
  - Add `--source yahoo` to fallback to Yahoo Finance
  - Add `--use-saved-params` to load from JSON file
  - Add specific `--fast-base`, `--slow-base`, etc. to override parameters

## Data Source Notes

**Alpaca (Recommended)**:
- Provides 4000+ hourly candles (vs yfinance ~730 day limit)
- Historical data back to 2016
- More reliable and consistent data
- Automatically used if ALPACA_API_KEY is set in .env

**Yahoo Finance (Fallback)**:
- Limited to ~730 days for hourly data
- Use only if Alpaca unavailable
- Add `--source yahoo` to force use
